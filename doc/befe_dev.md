# BEFE development

# Creating a new slow control module
In order to create a new slow control module, follow these steps:
* Create the vhd file for the new module, and make sure to:
   * Include the ipb_reset_i, ipb_clk_i, ipb_miso_o, and ipb_mosi_i ports
   * Include use work.registers.all;
   * Include two comments in the architecture section before begin:
      * ```------ Register signals begin (this section is generated by <gem_amc_repo_root>/scripts/generate_registers.py -- do not edit)```
      * ```------ Register signals end ----------------------------------------------```
   * Include two comments at the end of the architecture section just before the end architecture statement:
      * ```--==== Registers begin ==========================================================================```
      * ```--==== Registers end ============================================================================```
   * Include a g_IPB_CLK_PERIOD_NS generic of type integer
* Either add a new module in an existing XML e.g. gem_amc.xml, or create a new XML file with the module defined, and include it in all the relevant tmpl.xml files. The fw_module_file should refer to a vhd file of the new module.
* When ```make update_<flavor>_<board>``` command is run, it will generate the vhd files for each flavor and board combination in the ```<path_to_the_original_module_vhd>/generated``` directory
* Edit the ```ipb_addr_decode.vhd``` package (for GEMs it's in ```gem/hdl/pkg```, for CSCs it's in ```csc/hdl/pkg```, for system it's typically in ```boards/<board>/hdl/pkg```):
   * add an entry in t_ipb_slv with your module name e.g. ```config_blaster   : integer;```
   * increment the ```C_NUM_IPB_SLAVES```
   * add an entry in ```C_IPB_SLV``` with a new number just before the ```none``` entry,  e.g. ```config_blaster => 24,```
   * Add an elsif entry in the ipb_addr_sel function implementation which defines the address pattern of your new module, and selects the C_IPB_SLV with the new name you just added there. The address pattern should be the same as the top level ```address``` entry in the XML for your new module, but the top 8 bits should be marked as ```-``` (don't care), and also the bottom ```fw_reg_addr_msb - fw_reg_addr_lsb``` bits should also be marked as ```-``` (don't care). This function is used to select the appropriate slave module based on the global address.
* Edit all the appropriate ```Top/<flavor>_<board>/list/<flavor>_<board>.src``` files to include the generated vhd file of your new module e.g. to add a trigger module in the ```ge11_ctp7``` project, include ```gem/hdl/trigger/generated/ge11_ctp7/trigger.vhd```, these entries are typically located after a comment saying ```# sources with generated registers```. Make sure to include it in all the flavor and board combinations of GEM or CSC.

Note: when you work on your module VHDL code, always make sure to edit the original VHD file, and not the generated one (projects always include only the generated ones), because the genated files are overwritten when you run ```make update_<flavor>_<board>```
